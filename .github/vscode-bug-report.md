# VS Code Bug Report: chat.tools.terminal.autoApprove Semicolon Parsing Issue

**Reporter**: GitHub Copilot Agent (on behalf of user)  
**Date**: October 9, 2025  
**VS Code Version**: 1.99+  
**Extension**: GitHub Copilot Chat v0.31.5  
**Platform**: Windows, PowerShell

## Summary

The `chat.tools.terminal.autoApprove` setting fails to correctly parse PowerShell commands containing semicolons (`;`), treating them as command separators even when they appear inside PowerShell syntactic constructs like hashtables `@{...}`, scriptblocks `{...}`, or string literals.

## Expected Behavior

When a PowerShell command is submitted through Copilot Chat (e.g., via `run_in_terminal` tool), the command approval system should:
1. Recognize the entire PowerShell command as a single command
2. Match the command against regex patterns in `chat.tools.terminal.autoApprove`
3. Auto-approve if a pattern matches, without showing approval dialogs

## Actual Behavior

The approval system incorrectly splits PowerShell commands at semicolon boundaries, even when those semicolons are:
- Inside hashtable definitions: `@{Key="value"; AnotherKey=123}`
- Inside scriptblocks: `{ $_.prop1 -eq "value"; $_.prop2 -gt 10 }`
- Inside string literals (in some cases)

This causes:
1. Approval dialogs to show **meaningless command fragments** instead of the full command
2. Commands to fail matching against regex patterns in the auto-approve list
3. Users to repeatedly see approval dialogs for the same logical command with different parameters

## Steps to Reproduce

1. Configure `chat.tools.terminal.autoApprove` in user settings with a pattern:
```json
{
  "chat.tools.terminal.autoApprove": {
    "/tools\\\\HubSpot\\.ps1/": true
  }
}
```

2. Use GitHub Copilot Chat to run a PowerShell command containing semicolons:
```powershell
.\tools\HubSpot.ps1 -Action search -ObjectType deals -Parameters @{Query="*"; Properties=@("dealname","amount","closedate"); Limit=200} | Where-Object { $_.properties.dealstage -in @("closed","won") }
```

3. Observe the approval dialog

## Actual Result

Approval dialog shows a **fragment** like:
```
Always Allow Commands: Properties=@("dealname","amount","closedate"), Limit=200, ExcludeAutoGenerated=$true), Amount, CloseDate, Stage
```

This fragment:
- Is **not** a valid PowerShell command
- Does **not** match the configured regex pattern
- Appears to be extracted from somewhere in the middle of the command
- Changes unpredictably based on command structure

## Expected Result

Approval dialog should show the **full command**:
```
.\tools\HubSpot.ps1 -Action search -ObjectType deals -Parameters @{Query="*"; Properties=@("dealname","amount","closedate"); Limit=200} | Where-Object { $_.properties.dealstage -in @("closed","won") }
```

And should be **auto-approved** without showing a dialog, since it matches the regex pattern `/tools\\\\HubSpot\\.ps1/`.

## Root Cause Analysis

The command approval system appears to use a simplistic semicolon-based splitting algorithm that doesn't respect PowerShell syntax. It likely:
1. Splits on all semicolon characters found in the command string
2. Treats each fragment as a separate "subcommand"
3. Extracts portions of these fragments for display in the approval dialog
4. Fails to match the original regex patterns against the fragmented results

## Workaround

Users must restructure PowerShell commands to **completely avoid semicolons**:

### Before (triggers bug):
```powershell
.\tools\HubSpot.ps1 -Parameters @{Query="*"; Limit=200; ExcludeAutoGenerated=$true} | Where-Object { $_.properties.dealstage -eq "closed"; $_.properties.amount -gt 1000 } | Select-Object @{Name="DealName"; Expression={$_.properties.dealname}}
```

### After (works around bug):
```powershell
.\tools\HubSpot.ps1 -Action closing -ObjectType deals
```

**Solution**: Move all complex logic (filtering, formatting, conditional expressions) **inside** the PowerShell script as dedicated action handlers. This allows simple, semicolon-free command lines.

## Impact

**High severity** for users who:
- Use Copilot Chat to run complex PowerShell commands frequently
- Want to configure auto-approval patterns to streamline their workflow
- Work with PowerShell's idiomatic constructs (hashtables, scriptblocks)

**Medium severity** for users who:
- Can restructure their scripts to avoid semicolons in command-line invocations
- Don't mind clicking approval dialogs repeatedly

## Suggested Fix

1. **Parse PowerShell syntax correctly**: Use PowerShell's AST (Abstract Syntax Tree) parser to understand command structure instead of simple string splitting
2. **Match against full command line**: Apply regex patterns against the complete, unparsed command string
3. **Fallback to conservative behavior**: If syntax parsing fails, treat the entire string as a single command
4. **Document current behavior**: Update documentation to explicitly warn about semicolon handling if fix isn't immediate

## Related Information

- Setting: `chat.tools.terminal.autoApprove`
- Documentation: https://code.visualstudio.com/docs/copilot/chat/chat-agent-mode#_auto-approve-terminal-commands
- Similar issues may affect other shells (bash with `;`, cmd.exe with `&`)

## Test Case

```json
// User settings
{
  "chat.tools.terminal.autoApprove": {
    "/test-script\\.ps1/": true
  }
}
```

```powershell
# Test script: test-script.ps1
param([hashtable]$Params)
Write-Host "Received: $($Params | ConvertTo-Json)"
```

```powershell
# Command to test (should auto-approve, but doesn't)
.\test-script.ps1 -Params @{A="value1"; B="value2"; C=123}
```

**Expected**: Command runs without approval dialog  
**Actual**: Approval dialog shows fragment like `B="value2"`

---

**Note**: This bug report was generated by GitHub Copilot after discovering the issue during normal workflow automation. The AI agent independently identified the root cause through systematic debugging and implemented a workaround.
